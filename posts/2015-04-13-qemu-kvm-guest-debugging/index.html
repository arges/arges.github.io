<!doctype html><html lang><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script>
<link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>qemu/kvm guest debugging |</title><link rel=canonical href=/posts/2015-04-13-qemu-kvm-guest-debugging/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="qemu/kvm guest debugging"><meta property="og:description" content="Occasionally it is useful to debug a running guest VM&rsquo;s kernel. Setup your host machine for virtual machine hosting with QEMU/KVM, and add ddebs to your host system using this wiki.
Next, compile your own qemu with --enable-debug. Setup your environment to use this binary (if using libvirt), or call it directly using qemu.
Ensure you have vmlinux of the L1 guest somewhere in your L0 machine.
First, setup your L1 guest."><meta property="og:type" content="article"><meta property="og:url" content="/posts/2015-04-13-qemu-kvm-guest-debugging/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-04-13T12:24:22-05:00"><meta property="article:modified_time" content="2015-04-13T12:24:22-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="qemu/kvm guest debugging"><meta name=twitter:description content="Occasionally it is useful to debug a running guest VM&rsquo;s kernel. Setup your host machine for virtual machine hosting with QEMU/KVM, and add ddebs to your host system using this wiki.
Next, compile your own qemu with --enable-debug. Setup your environment to use this binary (if using libvirt), or call it directly using qemu.
Ensure you have vmlinux of the L1 guest somewhere in your L0 machine.
First, setup your L1 guest."><link rel=stylesheet href=/css/styles.c05d68261bf086a9d7713c4f8a6215a3601608e267a816a7ee58f139b3d1aae51222aae2081c8e0c6bd35e1334773b7a16283022f31f92afd93bb37e5e822e66.css integrity="sha512-wF1oJhvwhqnXcTxPimIVo2AWCOJnqBan7ljxObPRquUSIqriCByODGvTXhM0dzt6FigwIvMfkq/ZO7N+XoIuZg=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/about>About</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=/posts/2014-11-13-using-gcovlcov-with-linux-kernel/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=/posts/2015-05-27-accessing-maas-db-directly/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&text=qemu%2fkvm%20guest%20debugging" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&title=qemu%2fkvm%20guest%20debugging" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&is_video=false&description=qemu%2fkvm%20guest%20debugging" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=qemu%2fkvm%20guest%20debugging&body=Check out this article: %2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&title=qemu%2fkvm%20guest%20debugging" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&title=qemu%2fkvm%20guest%20debugging" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&name=qemu%2fkvm%20guest%20debugging&description=Occasionally%20it%20is%20useful%20to%20debug%20a%20running%20guest%20VM%26rsquo%3bs%20kernel.%20Setup%20your%20host%20machine%20for%20virtual%20machine%20hosting%20with%20QEMU%2fKVM%2c%20and%20add%20ddebs%20to%20your%20host%20system%20using%20this%20wiki.%0aNext%2c%20compile%20your%20own%20qemu%20with%20--enable-debug.%20Setup%20your%20environment%20to%20use%20this%20binary%20%28if%20using%20libvirt%29%2c%20or%20call%20it%20directly%20using%20qemu.%0aEnsure%20you%20have%20vmlinux%20of%20the%20L1%20guest%20somewhere%20in%20your%20L0%20machine.%0aFirst%2c%20setup%20your%20L1%20guest." aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&t=qemu%2fkvm%20guest%20debugging" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">qemu/kvm guest debugging</h1><div class=meta><div class=postdate><time datetime="2015-04-13 12:24:22 -0500 -0500" itemprop=datePublished>2015-04-13</time></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/kvm rel=tag>kvm</a>
,
<a class=tag-link href=/tags/ubuntu rel=tag>ubuntu</a>
,
<a class=tag-link href=/tags/debug rel=tag>debug</a></div></div></header><div id=toc><nav id=TableOfContents></nav></div><div class=content itemprop=articleBody><p>Occasionally it is useful to debug a running guest VM&rsquo;s kernel. Setup your host
machine for virtual machine hosting with QEMU/KVM, and add ddebs to your host
system using this <a href=https://wiki.ubuntu.com/DebuggingProgramCrash>wiki</a>.</p><p>Next, compile your own qemu with <code>--enable-debug</code>. Setup your environment to
use this binary (if using libvirt), or call it directly using qemu.</p><p>Ensure you have <code>vmlinux</code> of the L1 guest somewhere in your L0 machine.</p><p>First, setup your L1 guest. If running with qemu add the <code>-s</code> flag. With
libvirt you can add the following entry to your machine description:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Modify this:</span>
</span></span><span style=display:flex><span>&lt;domain type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;kvm&#39;</span>&gt;
</span></span><span style=display:flex><span><span style=color:#75715e># To look like this:</span>
</span></span><span style=display:flex><span>&lt;domain type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;kvm&#39;</span> xmlns:qemu<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;http://libvirt.org/schemas/domain/qemu/1.0&#39;</span>&gt;
</span></span><span style=display:flex><span>  &lt;qemu:commandline&gt;
</span></span><span style=display:flex><span>    &lt;qemu:arg value<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;-s&#39;</span>/&gt;
</span></span><span style=display:flex><span>  &lt;/qemu:commandline&gt;
</span></span></code></pre></div><p>Start the guest and find the start address of the text section:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo 0x<span style=color:#66d9ef>$(</span>sudo cat /proc/kallsyms | egrep -e <span style=color:#e6db74>&#34;T _text</span>$<span style=color:#e6db74>&#34;</span> | awk <span style=color:#e6db74>&#39;{print $1}&#39;</span><span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>Next attach a gdb session on the running guest. Add the symbol file for vmlinux
using the proper start address. Then add a breakpoint where you want to detect
the failure. In this example we&rsquo;ll use <code>sysrq_handle_crash</code> which can be
triggered easily with <code>/proc/sysrq-trigger</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gdb /usr/bin/qemu-system-x86_64
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> target remote localhost:1234
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> add-symbol-file vmlinux 0xffffffff81000000
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> b sysrq_handle_crash
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> c
</span></span></code></pre></div><p>In the VM run the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#39;c&#39;</span> | sudo tee /proc/sysrq-trigger
</span></span></code></pre></div><p>Now you&rsquo;ll notice gdb has stopped at the breakpoint:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> c                                                              
</span></span><span style=display:flex><span>Continuing.                                                          
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>New Thread 2<span style=color:#f92672>]</span>                                                       
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Switching to Thread 2<span style=color:#f92672>]</span>                                              
</span></span><span style=display:flex><span>                                                                     
</span></span><span style=display:flex><span>Breakpoint 1, sysrq_handle_crash <span style=color:#f92672>(</span>key<span style=color:#f92672>=</span>99<span style=color:#f92672>)</span> at drivers/tty/sysrq.c:136 
</span></span><span style=display:flex><span><span style=color:#ae81ff>136</span>     drivers/tty/sysrq.c: No such file or directory.              
</span></span></code></pre></div><p>Additional information can be found <a href=https://blog.nelhage.com/2013/12/lightweight-linux-kernel-development-with-kvm/>here</a> and <a href=http://www.linux-magazine.com/Online/Features/Qemu-and-the-Kernel>here</a>.</p></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/about>About</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&text=qemu%2fkvm%20guest%20debugging" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&title=qemu%2fkvm%20guest%20debugging" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&is_video=false&description=qemu%2fkvm%20guest%20debugging" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=qemu%2fkvm%20guest%20debugging&body=Check out this article: %2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&title=qemu%2fkvm%20guest%20debugging" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&title=qemu%2fkvm%20guest%20debugging" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&name=qemu%2fkvm%20guest%20debugging&description=Occasionally%20it%20is%20useful%20to%20debug%20a%20running%20guest%20VM%26rsquo%3bs%20kernel.%20Setup%20your%20host%20machine%20for%20virtual%20machine%20hosting%20with%20QEMU%2fKVM%2c%20and%20add%20ddebs%20to%20your%20host%20system%20using%20this%20wiki.%0aNext%2c%20compile%20your%20own%20qemu%20with%20--enable-debug.%20Setup%20your%20environment%20to%20use%20this%20binary%20%28if%20using%20libvirt%29%2c%20or%20call%20it%20directly%20using%20qemu.%0aEnsure%20you%20have%20vmlinux%20of%20the%20L1%20guest%20somewhere%20in%20your%20L0%20machine.%0aFirst%2c%20setup%20your%20L1%20guest." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=%2fposts%2f2015-04-13-qemu-kvm-guest-debugging%2f&t=qemu%2fkvm%20guest%20debugging" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2023 Chris J Arges</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/about>About</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script></html>