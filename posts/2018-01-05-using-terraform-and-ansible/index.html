<!doctype html><html lang><head><link rel=preload href=/chrisarges.net/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/chrisarges.net/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/chrisarges.net/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/chrisarges.net/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script>
<link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>using terraform with ansible |</title><link rel=canonical href=chrisarges.net/posts/2018-01-05-using-terraform-and-ansible/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="using terraform with ansible"><meta property="og:description" content="A lot of my work lately has been transforming one-off machines into systems that can be re-generated and re-deployed easily. For much of these we use Debian packaging and ansible. In many instances the output needs to be cloud images as well as things that can be imaged on baremetal. For this we use Packer which can drive ansible. While using ansible to describe how a system is composed is nice, we also need to describe how those systems will be deployed."><meta property="og:type" content="article"><meta property="og:url" content="chrisarges.net/posts/2018-01-05-using-terraform-and-ansible/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-01-05T15:24:58-06:00"><meta property="article:modified_time" content="2018-01-05T15:24:58-06:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="using terraform with ansible"><meta name=twitter:description content="A lot of my work lately has been transforming one-off machines into systems that can be re-generated and re-deployed easily. For much of these we use Debian packaging and ansible. In many instances the output needs to be cloud images as well as things that can be imaged on baremetal. For this we use Packer which can drive ansible. While using ansible to describe how a system is composed is nice, we also need to describe how those systems will be deployed."><link rel=stylesheet href=/chrisarges.net/css/styles.c05d68261bf086a9d7713c4f8a6215a3601608e267a816a7ee58f139b3d1aae51222aae2081c8e0c6bd35e1334773b7a16283022f31f92afd93bb37e5e822e66.css integrity="sha512-wF1oJhvwhqnXcTxPimIVo2AWCOJnqBan7ljxObPRquUSIqriCByODGvTXhM0dzt6FigwIvMfkq/ZO7N+XoIuZg=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=chrisarges.net/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=chrisarges.net/>Home</a></li><li><a href=chrisarges.net/about>About</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=chrisarges.net/posts/2016-05-20-creating-a-function-wrapper-in-golang/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=chrisarges.net/posts/2018-01-22-getting-activity-logs-from-azure/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&text=using%20terraform%20with%20ansible" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&title=using%20terraform%20with%20ansible" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&is_video=false&description=using%20terraform%20with%20ansible" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=using%20terraform%20with%20ansible&body=Check out this article: chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&title=using%20terraform%20with%20ansible" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&title=using%20terraform%20with%20ansible" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&name=using%20terraform%20with%20ansible&description=A%20lot%20of%20my%20work%20lately%20has%20been%20transforming%20one-off%20machines%20into%20systems%20that%20can%20be%20re-generated%20and%20re-deployed%20easily.%20For%20much%20of%20these%20we%20use%20Debian%20packaging%20and%20ansible.%20In%20many%20instances%20the%20output%20needs%20to%20be%20cloud%20images%20as%20well%20as%20things%20that%20can%20be%20imaged%20on%20baremetal.%20For%20this%20we%20use%20Packer%20which%20can%20drive%20ansible.%20While%20using%20ansible%20to%20describe%20how%20a%20system%20is%20composed%20is%20nice%2c%20we%20also%20need%20to%20describe%20how%20those%20systems%20will%20be%20deployed." aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&t=using%20terraform%20with%20ansible" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">using terraform with ansible</h1><div class=meta><div class=postdate><time datetime="2018-01-05 15:24:58 -0600 -0600" itemprop=datePublished>2018-01-05</time></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/devops rel=tag>devops</a>
,
<a class=tag-link href=/tags/ansible rel=tag>ansible</a>
,
<a class=tag-link href=/tags/terraform rel=tag>terraform</a></div></div></header><div id=toc><nav id=TableOfContents></nav></div><div class=content itemprop=articleBody><p>A lot of my work lately has been transforming one-off machines into systems
that can be re-generated and re-deployed easily. For much of these we use
Debian packaging and ansible. In many instances the output needs to be cloud
images as well as things that can be imaged on baremetal. For this we use
Packer which can drive ansible. While using ansible to describe how a system is
composed is nice, we also need to describe how those systems will be deployed.
This is where something like terraform comes in.</p><p>We wanted to figure out tools that would help accomplish a wide range of goals
without having to lock us into a particular provider. ansible is nice because it
is a client only architecture and works on a wide range of Linux distributions
and platforms. To manage deployment we could also just use ansible, but decided
we liked the ability to better describe services that may change in topology
and numbers without having to manually manage instances. In addition we want to
deploy to many different kinds of platforms like AWS, Azure, and VMWare.</p><p>One approach to doing all this would be build images in Packer with ansible,
then deploy with terraform. However we also wanted the ability to iterate a bit
more quickly with instances. This is where using terraform to drive ansible is
nice.</p><p>First install terraform from its binary (or build from source):</p><pre tabindex=0><code>wget https://releases.hashicorp.com/terraform/0.11.1/terraform_0.11.1_linux_amd64.zip
unzip terraform_0.11.1_linux_amd64.zip
sudo mv terraform /usr/local/bin/
</code></pre><p>Then create a terraform file:</p><pre tabindex=0><code>provider &#34;aws&#34; {
  region = &#34;us-east-2&#34;
}

resource &#34;aws_instance&#34; &#34;example&#34; {
  count = 2
  ami = &#34;ami-82f4dae7&#34;
  key_name = &#34;default&#34;
  instance_type = &#34;t2.micro&#34;
  tags {
    Name = &#34;terraform-example-${format(&#34;%02d&#34;, count.index+1)}&#34;
    Role = &#34;terraform-example&#34;
  }
}
</code></pre><p>This is pretty much a stock example of using terraform, but one thing that did
cause issues was using a static value for <code>tags.Name</code>. Without this change
using the terraform-inventory plugin did not work correctly.</p><p>To check what will be deployed use:</p><pre tabindex=0><code>terraform plan
</code></pre><p>If this looks ok use the following to apply it:</p><pre tabindex=0><code>terraform apply
</code></pre><p>Next we could just manually get the IPs from AWS and put them into an inventory
file, or we could use terraform output to get IPs. But since we&rsquo;re using
ansible it would be better to use dynamic inventory to get the machines we want
to deploy to. A dynamic inventory can be passed to ansible provided it
implements certain flags. Luckily there is already a terraform-ansible dynamic
inventory plugin.</p><p>To use it we need to install and set it up:</p><pre tabindex=0><code>git clone https://github.com/mantl/terraform.py
pip install ./terraform.py
cp terraform.py/scripts/terraform_inventory.sh .
</code></pre><p>We will use <code>terraform_inventory.sh</code> in the ansible command.</p><p>Install ansible:</p><pre tabindex=0><code>sudo apt-get install ansible
</code></pre><p>Finally create an ansible file we want to deploy as <code>provision.yml</code>:</p><pre tabindex=0><code>---
- hosts: all
  remote_user: ubuntu
  gather_facts: no
  become: yes
  tasks:
  - name: echo hello
    shell: echo &#34;hello&#34;
</code></pre><p>Now we can run the playbook against the terraform hosts:</p><pre tabindex=0><code>ansible-playbook --extra-vars=&#34;ansible_user=ubuntu&#34; -i terraform_inventory.sh provision.yml
</code></pre><p>Now you&rsquo;ll see it run against all your hosts.</p><p>Some refinements here would be we could tag our hosts and use the tag instead
of <code>all</code>. In addition we could also dynamically create a key using terraform
and then pass that into ansible.</p></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=chrisarges.net/>Home</a></li><li><a href=chrisarges.net/about>About</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&text=using%20terraform%20with%20ansible" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&title=using%20terraform%20with%20ansible" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&is_video=false&description=using%20terraform%20with%20ansible" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=using%20terraform%20with%20ansible&body=Check out this article: chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&title=using%20terraform%20with%20ansible" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&title=using%20terraform%20with%20ansible" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&name=using%20terraform%20with%20ansible&description=A%20lot%20of%20my%20work%20lately%20has%20been%20transforming%20one-off%20machines%20into%20systems%20that%20can%20be%20re-generated%20and%20re-deployed%20easily.%20For%20much%20of%20these%20we%20use%20Debian%20packaging%20and%20ansible.%20In%20many%20instances%20the%20output%20needs%20to%20be%20cloud%20images%20as%20well%20as%20things%20that%20can%20be%20imaged%20on%20baremetal.%20For%20this%20we%20use%20Packer%20which%20can%20drive%20ansible.%20While%20using%20ansible%20to%20describe%20how%20a%20system%20is%20composed%20is%20nice%2c%20we%20also%20need%20to%20describe%20how%20those%20systems%20will%20be%20deployed." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=chrisarges.net%2fposts%2f2018-01-05-using-terraform-and-ansible%2f&t=using%20terraform%20with%20ansible" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2023 Chris J Arges</div><div class=footer-right><nav><ul><li><a href=chrisarges.net/>Home</a></li><li><a href=chrisarges.net/about>About</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/chrisarges.net/js/code-copy.js></script></html>