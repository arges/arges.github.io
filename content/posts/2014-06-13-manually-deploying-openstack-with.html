---
layout: post
title: manually deploying openstack with a virtual maas on ubuntu trusty (part 1)
date: '2014-06-13T15:05:00.001-07:00'
author: arges
tags:
- openstack
- juju
- maas
- ubuntu
modified_time: '2014-06-16T09:28:03.867-07:00'
thumbnail: http://4.bp.blogspot.com/-AYzkHv8R9o8/U58a3XQcwsI/AAAAAAAAElk/ce9RZTfDSnE/s72-c/Manually+Deploying+Openstack+on+A+Virtual+MaaS+with+Ubuntu+Trusty.png
blogger_id: tag:blogger.com,1999:blog-7705678145617402978.post-1059807833305011032
blogger_orig_url: http://dinosaursareforever.blogspot.com/2014/06/manually-deploying-openstack-with.html
---

The goal of this new few series of posts is to be able to setup virtual machines to simulate a real-world openstack deployment using maas and juju. This goes through setting up a maas-server in a VM as well as setting up maas-nodes in VMs and getting them enlisted/commissioned into the maas-server. Next juju is configured to use the maas cluster. Finally, openstack is deployed using juju.

<br /><div><h2>Overview</h2><div><h3>Requirements</h3></div><div>Ideally, a large server with 16 cores, 32G memory, 500G disk. Obviously you can tweak this setup to work with less; but be prepared to lock up lesser machines. In addition your host machine needs to be able to support nested virtualization.<br /><h3><span style="font-family: inherit;">Topology</span></h3></div><div>Here is the basics of what will be setup for our virtual maas cluster. Each red box is a virtual machine with two interfaces. The eth0 interface in the VM connects to the NATed maas-internet network, while the VM’s eth1 interface connects to the isolated maas-management network. The number of maas-nodes should match what is required for the deployment; however it is simple enough to enlist more nodes later. I choose to use a public/private network in order to be more flexible later in how openstack networking is set up.<br /><div><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-AYzkHv8R9o8/U58a3XQcwsI/AAAAAAAAElk/ce9RZTfDSnE/s1600/Manually+Deploying+Openstack+on+A+Virtual+MaaS+with+Ubuntu+Trusty.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-AYzkHv8R9o8/U58a3XQcwsI/AAAAAAAAElk/ce9RZTfDSnE/s1600/Manually+Deploying+Openstack+on+A+Virtual+MaaS+with+Ubuntu+Trusty.png" height="299" width="640" /></a></div><h2>Setup Host Machine</h2><h3>Install Requirements</h3><div>First install all required programs on the host machine.</div><div><pre class="prettyprint">sudo apt-get install libvirt-bin qemu-kvm cpu-checker virtinst uvtool</pre></div><div><br /></div><div>Next, check if kvm is working correctly.</div><div><pre class="prettyprint">kvm-ok</pre></div><div><br /></div><div>Ensure nested KVM is enabled. (replace intel with amd if necessary)</div><div><pre class="prettyprint">cat /sys/module/kvm_intel/parameters/nested</pre></div><div><br /></div><div>This should output Y, if it doesn’t do the following:</div><div><pre class="prettyprint">sudo modprobe -r kvm_intel<br />sudo modprobe kvm_intel nested=1<br /></pre></div><div><br /></div><div>Ensure $USER is added to libvirtd group.</div><div><pre class="prettyprint">groups | grep libvirtd</pre></div><div><br /></div><div>Ensure host machine has SSH keys generated and setup. (Be careful, don’t overwrite your existing keys)</div><div><pre class="prettyprint">[ -d ~/.ssh ] || ssh-keygen -t rsa</pre></div><div><h3>Virtual Network Setup</h3></div><div>This step can be done via virt-manager, but also done via command line using virsh.</div><div>Setup a virtual network which uses NAT to communicate with the host machine with the following parameters:</div><div><pre class="prettyprint">Network Name: maas_internet<br />Network: 192.168.100.0/24<br />Do _not_ Enable DHCP.<br />Forwarding to physical network; Any physical device; NAT<br /></pre></div><div>And setup an isolated virtual network the following parameters: </div><div><pre class="prettyprint">Network Name: maas_management<br />Network: 10.10.10.0/24<br />Do _not_ Enable DHCP.<br />Isolated network;</pre></div></div></div></div><div><h2>Install the MAAS Server</h2><h3>Download and Start the Install</h3>Ensure you have virt-manager connected to the hypervisor.<br />While there are many ways we can create virtual machines, I chose the tool uvtool because it works well in Trusty and quickly creates VM based on the Ubuntu cloud image.<br /><br />Sync the latest cloud trusty cloud image:<br /><pre class="prettyprint">uvt-simplestreams-libvirt sync release=trusty arch=amd64</pre><br />Create a maas-server VM:<br /><pre class="prettyprint">uvt-kvm create maas-server release=trusty arch=amd64 --disk 20 --memory 2048 --password ubuntu</pre><br />After it boots, shut it down and &nbsp;edit the VM’s machine configuration.<br />Make the two network interfaces connect to maas_internet and maas_management respectively.<br /><br />Now edit /etc/network/interfaces to have the following:<br /><pre class="prettyprint">auto eth0<br />iface eth0 inet static<br />&nbsp; address 192.168.100.10<br />&nbsp; netmask 255.255.255.0<br />&nbsp; gateway 192.168.100.1<br />&nbsp; dns-nameservers 10.10.10.10 192.168.100.1<br /><br />auto eth1<br />iface eth1 inet static<br />&nbsp; address 10.10.10.10<br />&nbsp; netmask 255.255.255.0<br />&nbsp; dns-nameservers 10.10.10.10 192.168.100.1<br /><br /></pre>And follow the instructions here:<br /><a href="http://maas.ubuntu.com/docs/install.html#pkg-install">http://maas.ubuntu.com/docs/install.html#pkg-install</a><br /><br />Which is essentially:<br /><pre class="prettyprint">sudo apt-get install maas maas-dhcp maas-dns</pre></div><div><h3>MAAS Server Post Install Tasks</h3><a href="http://maas.ubuntu.com/docs/install.html#post-install">http://maas.ubuntu.com/docs/install.html#post-install</a><br /><br />First let’s check if the webpage is working correctly. Depending on your installation, you may need to proxy into a remote host hypervisor before accessing the webpage. If you’re working locally you should be able to access this address directly (as the libvirt maas_internet network is already connected to your local machine).<br /><br />If you need to access it indirectly (and 192.168.100.0 is a non-conflicting subnet):<br /><pre class="prettyprint">sshuttle -D -r &lt;hypervisor IP&gt; 192.168.100.0/24</pre><br />Access the following:<br /><a href="http://192.168.100.10/MAAS">http://192.168.100.10/MAAS</a><br />It should remind you that post installation tasks need to be completed.<br /><br />Let’s create the admin user from the hypervisor machine:<br />ssh ubuntu@192.168.100.10<br /><pre class="prettyprint">sudo maas-region-admin createadmin --username=root --email="user@host.com" --password=ubuntu</pre><br />If you want to limit the types of boot images that can be created you need to edit<br /><pre class="prettyprint">sudo vim /etc/maas/bootresources.yaml</pre><br />Import boot images, using the new root user you created to log in:<br /><a href="http://192.168.100.10/MAAS/clusters/">http://192.168.100.10/MAAS/clusters/</a><br />Now click 'import boot images' and be patient as it will take some time before these images are imported.<br /><br />Add a key for the host machine here:<br /><a href="http://192.168.100.10/MAAS/account/prefs/sshkey/add/">http://192.168.100.10/MAAS/account/prefs/sshkey/add/</a><br /><h3>Configure the MAAS Cluster</h3>Follow instructions here to setup cluster:<br /><a href="http://maas.ubuntu.com/docs/cluster-configuration.html">http://maas.ubuntu.com/docs/cluster-configuration.html</a><br /><br /><a href="http://192.168.100.10/MAAS/clusters/">http://192.168.100.10/MAAS/clusters/</a><br />Click on ‘Cluster master’<br />Click on edit interface eth1.<br /><pre class="prettyprint">Interface: eth1<br />Management: DHCP and DNS<br />IP: 10.10.10.10<br />Subnet mask: 255.255.255.0<br />Broadcast IP: 10.10.10.255<br />Router IP: 10.10.10.10<br />IP Range Low: 10.10.10.100<br />IP Range High: 10.10.10.200<br /></pre><br />Click Save Interface<br />Ensure Nodes Auto-Enlist<span class="Apple-tab-span" style="white-space: pre;"> </span><br /><br />Create a MAAS key and use that to log in:<br /><a href="http://192.168.100.10/MAAS/account/prefs/">http://192.168.100.10/MAAS/account/prefs/</a><br />Click on ‘+ Generate MAAS key’ and copy that down.<br /><br />Log into the maas-server, and then log into maas using the MAAS key:<br />maas login maas-server http://192.168.100.10/MAAS<br /><br />Now set all nodes to auto accept:<br /><pre class="prettyprint">maas maas-server nodes accept-all</pre><br />Setup keys on the maas-server so it can access the virtual machine host<br /><pre class="prettyprint">sudo mkdir -p ~maas<br />sudo chown maas:maas ~maas<br />sudo -u maas ssh-keygen<br /></pre><br />Add the pubkey in ~maas/.ssh/id_rsa.pub to the virsh servers authorized_keys and to the maas SSH keys (<a href="http://192.168.100.10/MAAS/account/prefs/sshkey/add/">http://192.168.100.10/MAAS/account/prefs/sshkey/add/</a>)<br /><pre class="prettyprint">sudo cat /home/maas/.ssh/id_rsa.pub</pre><br />Now install virsh to test a connection and allow the maas-server to control maas-nodes.<br /><pre class="prettyprint">sudo apt-get install libvirt-bin</pre><br />Test the connection to the hypervisor (replace ubuntu with hypervisor host user)<br /><pre class="prettyprint">sudo -u maas virsh -c qemu+ssh://ubuntu@192.168.100.1/system list --all</pre><h3>Confirm Maas-Server Networking</h3>Ensure we can reach important address via maas-server:<br /><pre class="prettyprint">host streams.canonical.com<br />host store.juju.ubuntu.com<br />host archive.ubuntu.com<br /></pre><br />And that we can download charms if needed:<br /><pre class="prettyprint">wget https://store.juju.ubuntu.com/charm-info</pre><h3>Setup Traffic Forwarding</h3>Setup maas-server to forward traffic from eth1 to eth0:<br /><br />You can type the following out manually or add it as an upstart script to ensure forwarding is setup properly each time add this file to <b>/etc/init/ovs-routing.conf </b>(thanks to Juan Negron):<br /><br /><pre class="prettyprint">description "Setup NAT rules for ovs bridge"<br /><br />start on runlevel [2345]<br /><br />env EXTIF="eth0"<br />env BRIDGE="eth1"<br /><br />task<br /><br />script<br />    echo "Configuring modules"<br />    modprobe ip_tables || :<br />    modprobe nf_conntrack || :<br />    modprobe nf_conntrack_ftp || :<br />    modprobe nf_conntrack_irc || :<br />    modprobe iptable_nat || :<br />    modprobe nf_nat_ftp || :<br /><br />    echo "Configuring forwarding and dynaddr"<br />    echo "1" &gt; /proc/sys/net/ipv4/ip_forward<br />    echo "1" &gt; /proc/sys/net/ipv4/ip_dynaddr<br /><br />    echo "Configuring iptables rules"<br />    iptables-restore &lt;&lt;-EOM<br />*nat<br />-A POSTROUTING -o ${EXTIF} -j MASQUERADE<br />COMMIT<br />*filter<br />:INPUT ACCEPT [0:0]<br />:FORWARD ACCEPT [0:0]<br />:OUTPUT ACCEPT [0:0]<br />-A FORWARD -i ${BRIDGE} -o ${EXTIF} -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT<br />-A FORWARD -i ${EXTIF} -o ${BRIDGE} -j ACCEPT<br />-A FORWARD -j LOG<br />COMMIT<br />EOM<br /><br />end script<br /></pre>Then start the service:<br /><pre class="prettyprint">sudo service ovs-routing start</pre><h3>Setup Squid Proxy</h3>Ensure squid proxy can access cloud images:<br /><pre class="prettyprint">echo "cloud-images.ubuntu.com" | sudo tee /etc/squid-deb-proxy/mirror-dstdomain.acl.d/98-cloud-images</pre><pre class="prettyprint">sudo service squid-deb-proxy restart</pre></div><div><h2>Install MAAS Nodes</h2>Now we can virt-install each maas-node on the hypervisor such that it automatically pxe boots and auto-enlists into MAAS. You can adjust the script below to create as many nodes as required. I’ve also simplified things by creating everything with dual nics and ample memory and hard drive space, but of course you could use custom machines per service. Compute-nodes need more compute power, ceph nodes will need more storage, and quantum-gateway will need dual nics. In addition you could specify raw disks instead of qcow2, or use storage pools; but in this case I wanted something simple that didn’t automatically use all the space it needed.<br /><br /><pre class="prettyprint">for i in {0..19}; do<br />  virt-install \<br />    --name=maas-node-${i} \<br />    --connect=qemu:///system --ram=4096 --vcpus=1 --hvm --virt-type=kvm \<br />    --pxe --boot network,hd \<br />    --os-variant=ubuntutrusty --graphics vnc --noautoconsole --os-type=linux --accelerate \<br />--disk=/var/lib/libvirt/images/maas-node-${i}.qcow2,bus=virtio,format=qcow2,cache=none,sparse=true,size=32 \<br />    --network=network=maas_internet,model=virtio \<br />    --network=network=maas_management,model=virtio <br />done<br /></pre><br />Now each node needs to be manually enlisted with the proper power configuration.<br /><a href="http://maas.ubuntu.com/docs/nodes.html#virtual-machine-nodes">http://maas.ubuntu.com/docs/nodes.html#virtual-machine-nodes</a><br /><br /><pre class="prettyprint">Host Name: maas-node-${i}.vmaas<br />Power Type: virsh<br />Power Address: qemu+ssh://ubuntu@192.168.100.1/system<br />Power ID: maas-node-${i}<br /></pre>Here we need to match the machines to the mac address and update the power requirements. &nbsp;You can get the mac addresses of each node by using the following on the hypervisor:<br /><br /><pre class="prettyprint">virsh dumpxml maas-node-${i} | grep "mac addr"</pre><br />Here is a script that helps automate some of this process, it can be run from the maas-server (replace USER ubuntu with the appropriate value) this matches mac address from virsh to the ones in maas and then sets up the power accordingly:<br /><br /><pre class="prettyprint">#!/usr/bin/python<br /><br />import sys, os, libvirt<br />from xml.dom.minidom import parseString<br />os.environ['DJANGO_SETTINGS_MODULE'] = 'maas.settings'<br />sys.path.append("/usr/share/maas")<br />from maasserver.models import Node, Tag<br /><br />hhost = 'qemu+ssh://ubuntu@192.168.100.1/system'<br /><br />conn = libvirt.open(hhost)<br />nodes_dict = {}<br />domains = conn.listDefinedDomains()<br />for node_name in domains:<br />    node = conn.lookupByName(node_name)<br />    node_xml = parseString(node.XMLDesc(0))<br />    node_mac1 = node_xml.getElementsByTagName('interface')[0].getElementsByTagName('mac')[0].getAttribute('address')<br />    nodes_dict[node_mac1] = node_name<br /><br />maas_nodes = Node.objects.all()<br />for node in maas_nodes:<br />    try:<br />        system_id = node.system_id<br />        mac = node.get_primary_mac()<br />        node_name = nodes_dict[str(mac)]<br />        node.hostname = node_name<br />        node.power_type = 'virsh'<br />        node.power_parameters = { 'power_address':hhost, 'power_id':node_name }<br />        node.save()<br />    except: pass<br /></pre><br />Note you will need python-libvirt and run the above command with something like the following:<br /><pre class="prettyprint">sudo -u maas ./setup-nodes.py</pre><h3>Setup Fastpath and Commission Nodes</h3>You most likely want to use fast-path installer on nodes to speed up installation times. Set all nodes to use fastpath installer using another bulk action on the nodes.<br /><br />After you have all this done, click bulk action commission.<br />You should see all your machines starting up if you set things up properly, give this some time. You should have all the nodes in the 'Ready' state in maas now!<br /><a href="http://192.168.100.10/MAAS/nodes/">http://192.168.100.10/MAAS/nodes/</a><br /><h3>Confirm DNS setup</h3>One point of trouble can be ensuring DNS is setup correctly. We can test this by starting a maas node and inside of that trying the following:<br /><pre class="prettyprint">dig streams.canonical.com<br />dig store.juju.ubuntu.com<br /></pre><br />If we can’t hit those, we’ll need to ensure the maas server is setup correctly.<br />Go to: <a href="http://192.168.100.10/MAAS/settings/">http://192.168.100.10/MAAS/settings/</a><br />Enter the host machines upstream DNS if necessary here, it should setup the bind configuration file and restart that service. After this re-test.<br /><br />In addition I had to disable dnssec-validation for bind. Edit the following file:<br /><pre class="prettyprint">sudo vim /etc/bind/named.conf.options</pre><br />And change the following value:<br /><pre class="prettyprint">dnssec-validation no;</pre><br />And restart the service:<br /><pre class="prettyprint">sudo service bind9 restart</pre><br />Now you have a working virtual maas setup using the latest Ubuntu LTS!</div><div><br /></div><div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-nAwPK-nWeaA/U58a_Kf7v4I/AAAAAAAAEls/8JACkxWF4xU/s1600/Screenshot+from+2014-06-10+13:57:30.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-nAwPK-nWeaA/U58a_Kf7v4I/AAAAAAAAEls/8JACkxWF4xU/s1600/Screenshot+from+2014-06-10+13:57:30.png" height="544" width="640" /></a></div><br /></div><div><br /></div>
